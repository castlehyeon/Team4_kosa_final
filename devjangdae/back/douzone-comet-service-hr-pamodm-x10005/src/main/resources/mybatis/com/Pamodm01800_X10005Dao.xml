<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.comet.service.hr.pamodm.dao.Pamodm01800_X10005Dao">

	<select id="HRPamodm01800_X10005Service_test" resultType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model">		
		SELECT -- [동서발전]행사정보 조회
				A.COMPANY_CD		-- A.회사코드
		        , A.EMP_NO		 	-- A.사원번호
		        , B.KOR_NM			-- B.성명
		       	, (
		       		SELECT
		       		COMET.FN_HR_UP_DEPT_NM2(A.COMPANY_CD, C.DEPT_CD , A.START_DT)
		       		FROM DUAL L
		       	  ) AS ORG 			-- L.소속
		        , C.DEPT_CD			-- C.레벨
		        , C.OGRP_CD			-- C.직군
		        , C.PSTN_CD			-- C.직급
		        , B.JNCO_DT			-- B.입사일
		        , D.PRMT_DT			-- D.승격일
		        , E.RETM_DT			-- E.퇴직예정일
		        , A.START_DT		-- A.시작일
		        , A.END_DT		 	-- A.종료일
		        , E.TM_CD_NM		-- E.시간코드
		        , A.DOF_TP		 	-- A.휴무유형
		        , A.START_TM		-- A.시작시간
		        , A.END_TM		 	-- A.종료시간
		        , A.DOF_TM_CNT		-- A.휴무시간
		        , A.LVE_TM_CNT 		-- A.이탈시간
		FROM
			HR_STRK_INFO_X10005 A
		
		    LEFT OUTER JOIN  (
		    					SELECT COMPANY_CD, EMP_NO, KOR_NM, JNCO_DT, DEPT_CD FROM HR_EMP_MST
		    ) B
		    ON A.COMPANY_CD = B.COMPANY_CD
		    AND A.EMP_NO = B.EMP_NO
		        
		    LEFT OUTER JOIN  (
		                        SELECT 
		                        RANK () OVER (PARTITION BY EMP_NO ORDER BY GNFD_DT DESC) AS ROW_IDX,
		                        COMPANY_CD, EMP_NO, DEPT_CD, OGRP_CD, PSTN_CD, GNFD_DT FROM HR_HUAN_DTL
		    ) C
		    ON A.COMPANY_CD = C.COMPANY_CD
		    AND A.EMP_NO = C.EMP_NO
		    AND C.ROW_IDX = 1
		        
		    LEFT OUTER JOIN (   
		        				SELECT MNG_DC AS PRMT_DT, COMPANY_CD, EMP_NO
		                        FROM HR_EMP_SDTL 
		                        WHERE MCLS_CD = 'EWP93'
		                        AND MNG_DC IS NOT NULL
		    ) D
		    ON A.COMPANY_CD = D.COMPANY_CD
		    AND A.EMP_NO = D.EMP_NO
		        
		    LEFT OUTER JOIN (   
		        				SELECT MNG_DC AS RETM_DT, COMPANY_CD, EMP_NO
		                        FROM HR_EMP_SDTL 
		                        WHERE MCLS_CD = 'EWP50'
		                        AND MNG_DC IS NOT NULL
		    ) E
		    ON A.COMPANY_CD = E.COMPANY_CD
		    AND A.EMP_NO = E.EMP_NO
		    
			LEFT OUTER JOIN (
								SELECT DISTINCT X.COMPANY_CD, W.EMP_NO, TM_CD_NM
			    				FROM HR_OFFTIME_MST X
			    				
			    				INNER JOIN (
			        						SELECT Z.TM_CD, Z.COMPANY_CD, Z.EMP_NO
			        						FROM HR_STRK_INFO_X10005 Y
			        						
			        							LEFT OUTER JOIN 
			        											HR_OFFDAILY_MST Z
						        				ON Y.EMP_NO = Z.EMP_NO 
						        				AND Y.START_DT = Z.BWRK_DT 
						        				AND Y.COMPANY_CD = Z.COMPANY_CD
			    				) W
			    				ON (X.WORKTM_CD = W.TM_CD)
			) E
			ON A.COMPANY_CD = E.COMPANY_CD
			AND A.EMP_NO = E.EMP_NO
	</select>
	
	<select id="list_HR_STRK_INFO_X10005MST" resultType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model">		
		SELECT -- [동서발전]행사정보 조회
				A.COMPANY_CD		-- A.회사코드
		        , A.EMP_NO		 	-- A.사원번호
		        , B.KOR_NM			-- B.성명
		       	, (
		       		SELECT
		       		COMET.FN_HR_UP_DEPT_NM2(A.COMPANY_CD, C.DEPT_CD , A.START_DT)
		       		FROM DUAL L
		       	  ) AS ORG 			-- L.소속
		        , C.DEPT_CD			-- C.레벨
		        , C.OGRP_CD			-- C.직군
		        , C.PSTN_CD			-- C.직급
		        , B.JNCO_DT			-- B.입사일
		        , D.PRMT_DT			-- D.승격일
		        , E.RETM_DT			-- E.퇴직예정일
		        , A.START_DT		-- A.시작일
		        , A.END_DT		 	-- A.종료일
		        , E.TM_CD_NM		-- E.시간코드
		        , A.DOF_TP		 	-- A.휴무유형
		        , A.START_TM		-- A.시작시간
		        , A.END_TM		 	-- A.종료시간
		        , A.DOF_TM_CNT		-- A.휴무시간
		        , A.LVE_TM_CNT 	-- A.이탈시간
		FROM
			HR_STRK_INFO_X10005 A
		
		    LEFT OUTER JOIN  (
		    					SELECT COMPANY_CD, EMP_NO, KOR_NM, JNCO_DT, DEPT_CD FROM HR_EMP_MST
		    ) B
		    ON A.COMPANY_CD = B.COMPANY_CD
		    AND A.EMP_NO = B.EMP_NO
		        
		    LEFT OUTER JOIN  (
		                        SELECT 
		                        RANK () OVER (PARTITION BY EMP_NO ORDER BY GNFD_DT DESC) AS ROW_IDX,
		                        COMPANY_CD, EMP_NO, DEPT_CD, OGRP_CD, PSTN_CD, GNFD_DT FROM HR_HUAN_DTL
		    ) C
		    ON A.COMPANY_CD = C.COMPANY_CD
		    AND A.EMP_NO = C.EMP_NO
		    AND C.ROW_IDX = 1
		        
		    LEFT OUTER JOIN (   
		        				SELECT MNG_DC AS PRMT_DT, COMPANY_CD, EMP_NO
		                        FROM HR_EMP_SDTL 
		                        WHERE MCLS_CD = 'EWP93'
		                        AND MNG_DC IS NOT NULL
		    ) D
		    ON A.COMPANY_CD = D.COMPANY_CD
		    AND A.EMP_NO = D.EMP_NO
		        
		    LEFT OUTER JOIN (   
		        				SELECT MNG_DC AS RETM_DT, COMPANY_CD, EMP_NO
		                        FROM HR_EMP_SDTL 
		                        WHERE MCLS_CD = 'EWP50'
		                        AND MNG_DC IS NOT NULL
		    ) E
		    ON A.COMPANY_CD = E.COMPANY_CD
		    AND A.EMP_NO = E.EMP_NO
		    
			LEFT OUTER JOIN (
								SELECT DISTINCT X.COMPANY_CD, W.EMP_NO, TM_CD_NM
			    				FROM HR_OFFTIME_MST X
			    				
			    				INNER JOIN (
			        						SELECT Z.TM_CD, Z.COMPANY_CD, Z.EMP_NO
			        						FROM HR_STRK_INFO_X10005 Y
			        						
			        							LEFT OUTER JOIN 
			        											HR_OFFDAILY_MST Z
						        				ON Y.EMP_NO = Z.EMP_NO 
						        				AND Y.START_DT = Z.BWRK_DT 
						        				AND Y.COMPANY_CD = Z.COMPANY_CD
			    				) W
			    				ON (X.WORKTM_CD = W.TM_CD)
			) E
			ON A.COMPANY_CD = E.COMPANY_CD
			AND A.EMP_NO = E.EMP_NO
		WHERE 1=1
        
		<if test=' P_COMPANY_CD[0] != null and P_COMPANY_CD[0] != "" '>
			AND A.COMPANY_CD IN
			<foreach item="item" index="index" collection="P_COMPANY_CD"
				open="(" separator="," close=")"> #{item} </foreach>
		</if>
		
		<if test=' P_DEPT_CD[0] != null and P_DEPT_CD[0] != "" '>
			AND C.DEPT_CD IN
			<foreach item="item" index="index" collection="P_DEPT_CD"
				open="(" separator="," close=")"> #{item} </foreach>
		</if>
		
		<if test=' P_START_DT != null and P_START_DT != "" or P_END_DT != null and P_END_DT != "" '> 
			AND		(((FN_COALESCE (A.END_DT, '99991231')) BETWEEN #{P_START_DT} AND #{P_END_DT}) 
			OR 		((FN_COALESCE (A.END_DT, '99991231')) = '99991231')) -- (A.START_DT ='20230109' AND A.END_DT ='20230128')
		</if>
		
		<if test=' P_DOF_TP != null and P_DOF_TP != "" '>
			AND A.DOF_TP = #{P_DOF_TP} -- C.DEPT_CD ='1000200' -- A.DOF_TP = '0002'
		</if>
		ORDER BY START_DT
	</select>
	
	<select id="getCompanyCode" parameterType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model" resultType="String">
		SELECT
			DISTINCT COMPANY_CD 
		FROM
			HR_STRK_INFO_X10005 
		WHERE
			EMP_NO = #{emp_no}
	</select>
	
	<delete id="delete_HR_STRK_INFO_X10005MST" parameterType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model">
		DELETE
		FROM
			HR_STRK_INFO_X10005
		WHERE
			COMPANY_CD = #{company_cd}
			AND EMP_NO = #{emp_no}
			AND START_DT = #{start_dt}
			AND END_DT = #{end_dt}
	</delete>
	
	<update id="update_HR_STRK_INFO_X10005MST" parameterType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model">
		UPDATE
			HR_STRK_INFO_X10005	
		SET
			  DOF_TP = #{dof_tp} 			--휴무유형
			, START_TM = #{start_tm} 		--시작시간
			, END_TM = #{end_tm} 			--종료시간
			, DOF_TM_CNT = #{dof_tm_cnt} 	--휴무시간
			, LVE_TM_CNT = #{lve_tm_cnt} 	--이탈시간
			, UPDATE_ID = #{update_id} 		--수정ID
			, UPDATE_IP = #{update_ip} 		--수정IP
			, UPDATE_MCADDR_NM = '' 		--수정맥어드레스명
			, UPDATE_DTS = #{update_dts} 	--수정일시
		WHERE
			COMPANY_CD = #{company_cd}
			AND EMP_NO = #{emp_no}
			AND START_DT = #{start_dt}
			AND END_DT = #{end_dt}
	</update>
	
	<insert id="insert_HR_STRK_INFO_X10005MST" parameterType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model">
		INSERT INTO HR_STRK_INFO_X10005 
		(
			  COMPANY_CD
			, EMP_NO
			, START_DT
			, END_DT
			, DOF_TP
			, START_TM
			, END_TM
			, DOF_TM_CNT
			, LVE_TM_CNT
			, INSERT_ID
			, INSERT_IP
			, INSERT_DTS
		)
		VALUES 
		(
			  #{company_cd}
			, #{emp_no}
			, #{start_dt}
			, #{end_dt}
			, #{dof_tp}
			, #{start_tm}
			, #{end_tm}
			, #{dof_tm_cnt}
			, #{lve_tm_cnt}
			, #{insert_id}
			, #{insert_ip}
			, #{insert_dts}
		)
	</insert>
	
	<select id="hasContainPrimaryKey" parameterType="com.douzone.comet.service.hr.pamodm.models.Pamodm01800_X10005Model" resultType="Integer">
		SELECT
			COUNT(*)
		FROM
			HR_STRK_INFO_X10005
		WHERE
			COMPANY_CD = #{company_cd}
			AND EMP_NO = #{emp_no}
			AND START_DT = #{start_dt}
			AND END_DT = #{end_dt}
	</select>
</mapper>
