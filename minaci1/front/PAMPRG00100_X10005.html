<!--##be5588fd-c26b-4744-a415-802b008ae4b2##-->
<!--##PAMPRG00100_X10005##-->
<!--##42MtyM4KB7IkwlgI6esnSZjA/dLnrRM7YwrDjkmsouM+RAVwxU3GQhIoG1do6TaY##-->
<!--
  DEWS UI/UX IDE - Build Result - v1.5
  # PageID: PAMPRG00100_X10005
  # PageTitle: 승급기준표등록
  # Server: http://localhost:8090/
-->
<!--

-->

<div class="dews-button-group" style="text-align: right;">
  <button id="copybtnApply" class="dews-ui-button">종전자료복사</button>
  <button id="downloadBtnTemplet" class="dews-ui-button">엑셀템플릿다운로드</button>
  <button id="downloadBtnData" class="dews-ui-button">엑셀다운로드</button>
  <button id="uploadBtnApply" class="dews-ui-button">엑셀업로드</button>
  <button id="bulkExcelUpload" class="dews-ui-button">대량엑셀업로드</button>
</div>
<div id="conditionpanel" class="dews-ui-condition-panel" data-dews-columns="2">
  <ul class="required-area">
    <li>
      <label class="dews-ui-multilingual">승급년월</label>
      <span>
        <input type="text" id="mpPROMO_YEAR_MONTH" name="mpPROMO_YEAR_MONTH" class="dews-ui-monthpicker required" style="width: 145px;" />
        <button id="aply_ym_btn" class="dews-ui-button ico-search"></button>
      </span>
    </li>
    <li>
      <label class="dews-ui-multilingual">사업장</label>
      <span>
        <select id="bizarea_cd" name="bizarea_cd" class="dews-ui-dropdownlist required" data-dews-value-field="BIZAREA_CD" data-dews-text-field="BIZAREA_NM" data-dews-show-tooltip="true" data-dews-show-value-tooltip="true" data-dews-use-numkey="false"></select>
      </span>
    </li>
  </ul>
</div>
<div id="containerpanel1" class="dews-ui-container-panel" data-dews-container-height="263" data-dews-fit-bottom="true">
  <div id="containerpanelitem1" class="dews-container-item" data-dews-position="normal">
    <div id="gridMaster" class="dews-ui-grid"></div>
  </div>
</div>
<div id="excelFormGrid" class="dews-ui-grid"></div>
<div id="importExcelGrid" class="dews-ui-grid"></div>
<div id="containerpanel3" class="dews-ui-container-panel">
  <div id="containerpanelitem3" class="dews-container-item" data-dews-position="normal">
    <div><form id="uploadForm" action="/HRPamprg00100_X10005_BulkUploadService/uploadFile_HR_URGDBASETBL_INFO_X10005MST" method="POST" enctype="multipart/form-data">
    <input type="file" name="file" id="uploader" class="dews-ui-file" data-dews-download-use="false" style="display: none;"> <!-- 화면에서 숨김 -->
    <label for="uploader" id="uploadButton">Upload File</label> <!-- 업로드 버튼 생성 -->
</form>
 
</div>
  </div>
</div>
<div id="conditionpanel2" class="dews-ui-condition-panel" data-dews-label-align="left">
  <ul class="required-area">
    <li>
      <label class="dews-ui-multilingual">라벨</label>
      <span>
        <input id="ssss" name="ssss" type="text" class="dews-ui-textbox" style="width: 100px;" />
        <button id="sssss" class="dews-ui-button"></button>
      </span>
    </li>
  </ul>
</div>

<style>
    
</style>



<script>
  dews.ready(function () {
    var self = this;
    self.version = self.version || {};
    self.version.view='1.0';


    /*bf8a1f3b-4f27-439e-8495-a190c78bb027*/ //# sourceURL=PAMPRG00100_X10005.js
    
    self.mainButtons.delete.useDefaultConfirm = false;
    //사용자에게 기본으로 설정된 확인 메시지를 출력 후 확인 받았을 경우에만 핸들러를 실행합니다. (※ 생략가능 / 기본값: true)
    
    // PSTN_NM 처리
    var pstnNmMap = {
        '대표이사': 11,
        '감사': 13,
        '전무이사': 14,
        '이사': 16,
        '부장': 17,
        '차장': 18,
        '과장': 19,
        '대리': 20,
        '사원': 21
    };
    
    
    function getCurrentMonth() {
        var date = new Date();
        var year = date.getFullYear();              //yyyy
        var month = (1 + date.getMonth());          //M
        month = month >= 10 ? month : '0' + month;  //month 두자리로 저장
    
        return year + '' + month;
    }
    
    // 데이터를 로컬 스토리지에 저장하는 함수
    function saveDataToLocalStorage(data) {
        localStorage.setItem('gridData', JSON.stringify(data));
    }
    
    // 데이터를 로컬 스토리지에서 가져오는 함수
    function getDataFromLocalStorage() {
        var storedData = localStorage.getItem('gridData');
        return storedData ? JSON.parse(storedData) : [];
    }
    
    function searchData() {
        dews.ui.loading.show();
        //self.grid_ds.read();
        //로컬 스토리지에서 데이터 가져오기
        // var storedData = getDataFromLocalStorage();
    
        // if (storedData && storedData.length > 0) {
        //     // 로컬 스토리지에 데이터가 있을 경우, 그 데이터를 그리드 데이터로 설정
        //     self.grid_ds.data(storedData);
        // } else {
        //     // 로컬 스토리지에 데이터가 없을 경우, 빈 데이터를 그리드에 설정
        //     self.grid_ds.data([]); // 빈 데이터 설정
        // 그리드 데이터 로드
        self.grid_ds.read();
        dews.ui.loading.hide();
        //  saveDataToLocalStorage(self.grid_ds.data());
    }
    
    // 중복데이터 정렬, 그룹화
    function handleDuplicateData() {
        var allData = self.gridMaster.dataItems();
        var groupedDataMap = new Map(); // 중복 데이터를 그룹화하는 Map
    
        // 데이터를 combinedKey를 기준으로 정렬
        allData.sort(function (a, b) {
            return a.COMBINED_KEY.localeCompare(b.COMBINED_KEY);
        });
    
        console.log("allData" + allData);
    
        for (var i = 0; i < allData.length; i++) {
            var rowData = allData[i];
            var combinedKey = rowData.COMBINED_KEY; // 결합키로 중복확인
    
            if (!groupedDataMap.has(combinedKey)) { // key: 결합키, value: allData[i]
                // 그룹이 없는 경우, 새로운 그룹 생성
                groupedDataMap.set(combinedKey, [rowData]);
            } else {
                // 이미 그룹이 있는 경우, 해당 그룹에 추가
                groupedDataMap.get(combinedKey).push(rowData);
            }
        }
    
        var processedData = [];
        var sortedCombinedKeys = Array.from(groupedDataMap.keys()).sort();
    
        // 정렬된 combinedKey에 따라 데이터를 추가
        for (var key of sortedCombinedKeys) {
            var group = groupedDataMap.get(key);
            if (group.length > 1) {
                // 중복된 데이터가 있는 그룹 처리
                for (var k = 0; k < group.length; k++) {
                    if (k === 0) {
                        // 최상위 데이터는 그룹에 추가
                        processedData.push(group[k]);
                        //최상위 행 css
                        var rowNo = self.gridMaster.getDataIndexFromItemIndex(group[k].SEQ - 1);
                        self.gridMaster.setRowStyle(rowNo, { background: '#FFFFFF' }); //최상위 데이터 하얀색. 원래는 테두리 입히고 싶었으나 함수 못찾음 
                    } else {
                        // 최상위 데이터를 제외한 나머지 데이터에 CSS 입히기
                        var rowIndex = self.gridMaster.getDataIndexFromItemIndex(group[k].SEQ - 1);
                        self.gridMaster.setRowStyle(rowIndex, { background: '#FFE4E1' }); // 분홍색
                        self.gridMaster.setCheck(rowIndex, true, false);
                        processedData.push(group[k]);
                    }
                }
            } else {
                // 중복된 데이터가 없는 그룹 처리
                processedData.push(group[0]);
            }
        }
    
        console.log("processedData" + processedData);
        // 그리드에 바인딩
        self.grid_ds.data = processedData;
        self.gridMaster.setDataSource(self.grid_ds);
        self.gridMaster.sort({ field: 'COMBINED_KEY', dir: 'asc' }); // COMBINED_KEY 기준으로 정렬, 오름차순
    
    }
    
    
    function checkListExist() { // 데이터 삭제 전, 자료가 존재하는지 확인
        var existFlag = false;
        var allData = self.gridMaster.dataItems();
    
        if (allData.length > 0) {
            existFlag = true;
        }
        return existFlag;
    }
    
    function deleteBeforeList() {
        dews.api.get(dews.url.getApiUrl("HR", "HRPamprg00100_X10005Service", "delete_BeforeList"), {
            async: false,
            data: {
                mpPROMO_YEAR_MONTH: self.mpPROMO_YEAR_MONTH.value(),
                bizarea_cd: self.bizarea_cd.value()
            }
        }).done(function (data) {
        }).fail(function (message) {
            dews.ui.snackbar.warning(message.responseJSON.message);
        });
    }
    
    function copyBeforeList() {
        dews.api.get(dews.url.getApiUrl("HR", "HRPamprg00100_X10005Service", "copy_BeforeList"), {
            async: false,
            data: {
                mpPROMO_YEAR_MONTH: self.mpPROMO_YEAR_MONTH.value(),
                bizarea_cd: self.bizarea_cd.value()
            }
        }).done(function (data) {
            dews.ui.snackbar.ok("종전자료복사가 완료되었습니다.");
            searchData();
        }).fail(function (message) {
            dews.ui.snackbar.warning(message.responseJSON.message);
        });
    }
    
    function processImportData() {
    
        var importDataCount = self.importExcelGrid.dataItems().length;
        var rowNum = self.gridMaster.dataItems().length;
    
    
        console.log("importDataCount" + importDataCount);
    
        for (var i = 0; i < importDataCount; i++) {
            self.gridMaster.addRow(rowNum);
            var idx = self.gridMaster.select();
            var pstnNm = self.importExcelGrid.getCellValue(i, 'PSTN_NM');
            // TRGT_GRD_CD 처리 (기본값 'K1' 설정)
            var trgtGrdCd = self.importExcelGrid.getCellValue(i, 'TRGT_GRD_CD');
            trgtGrdCd = (trgtGrdCd == null || trgtGrdCd == undefined) ? 'K1' : trgtGrdCd;
    
            // UGRD_GRD_CD 처리 (기본값 'K2' 설정)
            var ugrdGrdCd = self.importExcelGrid.getCellValue(i, 'UGRD_GRD_CD');
            ugrdGrdCd = (ugrdGrdCd == null || ugrdGrdCd == undefined) ? 'K2' : ugrdGrdCd;
    
            // MIN_BWRK_MY 처리 (기본값 30 설정)
            var minBwrkMy = parseInt(self.importExcelGrid.getCellValue(i, 'MIN_BWRK_MY'));
            minBwrkMy = isNaN(minBwrkMy) ? 30 : minBwrkMy; // 숫자가 아니면 기본값 30으로 설정
    
            self.gridMaster.setCellValue(idx, 'PSTN_NM', self.importExcelGrid.getCellValue(i, 'PSTN_NM'), false);
            self.gridMaster.setCellValue(idx, 'PSTN_CD', pstnNmMap[pstnNm], false);
            self.gridMaster.setCellValue(idx, 'bizarea_cd', self.bizarea_cd.value(), false);
            self.gridMaster.setCellValue(idx, 'SEQ', rowNum += 1, false); // 순번 컬럼에 값 설정
            self.gridMaster.setCellValue(idx, 'STD_YM', self.importExcelGrid.getCellValue(i, 'STD_YM'), false); // 기준년월에 "승급년월" 저장
            self.gridMaster.setCellValue(idx, 'TRGT_GRD_CD', trgtGrdCd, false); // 대상등급
            self.gridMaster.setCellValue(idx, 'UGRD_GRD_CD', ugrdGrdCd, false); // 승급등급
            self.gridMaster.setCellValue(idx, 'MIN_BWRK_MY', minBwrkMy, false); // 최소근무월수
            self.gridMaster.setCellValue(idx, 'BWRK_MY_CALC_STD_DT', self.mpPROMO_YEAR_MONTH.value() + "01", false); // 산정기준일
    
            // 'STD_YM', 'bizarea_cd', 'PSTN_CD', 'TRGT_GRD_CD'를 결합하여 'COMBINED_KEY' 생성
            var combinedKey = self.importExcelGrid.getCellValue(i, 'STD_YM') + '-' + self.bizarea_cd.value() + '-' + pstnNmMap[pstnNm] + '-' + trgtGrdCd + '-' + ugrdGrdCd + '-' + minBwrkMy;
            self.gridMaster.setCellValue(idx, 'COMBINED_KEY', combinedKey, false);// 결합키 
        }
    }
    
    function importExcel(e) {
        var errMsg = [];
        var stdYmMaxLength = 6;
        var pstnCdMaxLength = 5;
        var grdCdMaxLength = 5;
        var minBwrkMyMaxLength = 1000000;
        var titleDepth = 1;
    
        // 데이터 소스 초기화
        self.importExcel_ds.data([]);
    
        // 엑셀 업로드 로딩바
        dews.ui.loading.show({ text: '엑셀 업로드 진행 중입니다.' });
    
        // 데이터 소스 바인딩
        self.importExcelGrid.importExcel({
            fileDialog: true,
            titleDepth: titleDepth,
            mapping: {
                "STD_YM": "기준년월",
                "PSTN_NM": "직급명",
                "TRGT_GRD_CD": "대상등급",
                "UGRD_GRD_CD": "승급등급",
                "MIN_BWRK_MY": "최소근무월수",
                "AGGR_TERM_CNT": "근무성적집계기간",
                "BWRK_SGRAD_CD": "근무성적",
                "LEDU_CD": "학력코드",
                "BWRK_MY_CALC_STD_DT": "산정기준일",
                "RMK_NM": "비고",
            },
            validator: function (row) {
                dews.ui.loading.hide();
                var msg = '';
    
                //기본키 누락시 업로드 실패
                if (!row.STD_YM || row.STD_YM.length > stdYmMaxLength) {
                    msg = dews.string.format("기준년월이 올바르지 않습니다.\n확인 후 업로드 하십시오.({0})", row.STD_YM);
                    console.error(msg); //콘솔에 값누락 확인 
                    return false;
                } else if (!row.PSTN_NM || row.PSTN_NM.length > pstnCdMaxLength) {
                    msg = dews.string.format("직급명이 올바르지 않습니다.\n확인 후 업로드 하십시오.({0}/{1})", row.STD_YM, row.PSTN_NM);
                    console.error(msg);
                    return false;
                } else if (!row.TRGT_GRD_CD || row.TRGT_GRD_CD.length > grdCdMaxLength) {
                    msg = dews.string.format("대상등급이 올바르지 않습니다.\n확인 후 업로드 하십시오.({0}/{1}/{2})", row.STD_YM, row.PSTN_CD, row.TRGT_GRD_CD);
                    console.error(msg);
                    return false;
                } else if (!row.UGRD_GRD_CD || row.UGRD_GRD_CD.length > grdCdMaxLength) {
                    msg = dews.string.format("승급등급이 올바르지 않습니다.\n확인 후 업로드 하십시오.({0}/{1}/{2}/{3})", row.STD_YM, row.PSTN_CD, row.TRGT_GRD_CD, row.UGRD_GRD_CD);
                    console.error(msg);
                } else if (!row.MIN_BWRK_MY || row.MIN_BWRK_MY.length > minBwrkMyMaxLength) {
                    msg = dews.string.format("최소근무월수가 올바르지 않습니다.\n확인 후 업로드 하십시오.({0}/{1}/{2}/{3}/{4})", row.STD_YM, row.PSTN_CD, row.TRGT_GRD_CD, row.UGRD_GRD_CD, row.MIN_BWRK_MY);
                    console.error(msg);
                    return false;
                }
    
                if (msg) {
                    errMsg.push(msg);
                    console.error(msg);
                    return false;
                }
                return true;
            }
        }).done(function (result) {
            dews.ui.loading.hide();
    
            if (result && result.totalCount === result.success.count) {
                for (var i = 0; i < result.success.count; i++) {
                    self.importExcelGrid.setRowState(i, "created");
                }
                dews.ui.snackbar.info(result.totalCount + "건 데이터를 불러왔습니다.");
            } else {
                self.grid_ds.data([]); // 일부라도 불러오지 못하면 데이터 초기화
                if (errMsg.length > 0) {
                    dews.error(errMsg[0]);
                }
            }
    
            dews.ui.snackbar.info(result.totalCount + "건의 데이터를 입력하셨습니다.");
            self.gridMaster.clearRows(); //fd에서 데이터 삭제
            processImportData(); //업로드그리드 -> 마스터그리드로 데이터 전달
            handleDuplicateData(); //마스터그리드 데이터 정렬 
    
            var checkedIndices = self.gridMaster.getCheckedIndex();
            if (checkedIndices.length > 0) {
                dews.ui.snackbar.info("중복된 데이터 삭제바랍니다.");
                var rowIndex = checkedIndices[0]; // 첫 번째 선택된 행의 인덱스 가져오기
                self.gridMaster.select(rowIndex, 'STD_YM'); // 해당 행 선택(focus효과)
            }
    
    
        }).fail(function (error) {
            console.error(error);
            dews.ui.loading.hide();
            dews.ui.snackbar.warning("엑셀 업로드 실패했습니다. 파일을 확인해주세요.");
        }).always(function () {
            e.target.value = ""; // e 초기화
        });
    }
    
    function OpenDialogYm() {
        var dialog = dews.ui.dialog("PAMPRG00100_YM", {
            url: "/view/HR/PAMPRG00100_YM",
            title: '년월',
            initData: { bizarea_cd: self.bizarea_cd.value() },
            size: "small",
            height: 420,
            buttons: 'applyAndClose',
            ok: function (data) {
                console.log("여기 돌이오냐");
                self.mpPROMO_YEAR_MONTH.value(data.STD_YM);
                dews.ui.mainbuttons.search.click();
            }
        });
        dialog.open();
    }
    
    
    
    
    
    self.grid_ds = dews.ui.dataSource('grid_ds', {
      grid: true,
      transport: {
        read: {
          url: dews.url.getApiUrl('HR', 'HRPamprg00100_X10005Service', 'list_HR_URGDBASETBL_INFO_X10005MST'),
          data: /*7ee5833f-901a-4df1-9b1d-c782bd84fb79*/ function() {
        return{
        mpPROMO_YEAR_MONTH: self.mpPROMO_YEAR_MONTH.value(),
        bizarea_cd: self.bizarea_cd.value()
      }
    }
    
        }
      },
      schema: {
        model: {
          fields: [
            { field: 'STD_YM', editable: false, dataType: 'string' }, 
            { field: 'PSTN_CD', editable: false, dataType: 'string' }, 
            { field: 'PSTN_NM', editable: false, dataType: 'string' }, 
            { field: 'TRGT_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'UGRD_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'MIN_BWRK_MY', editable: false, dataType: 'number' }, 
            { field: 'AGGR_TERM_CNT', editable: false, dataType: 'number' }, 
            { field: 'BWRK_SGRAD_CD', editable: false, dataType: 'string' }, 
            { field: 'LEDU_CD', editable: false, dataType: 'string' }, 
            { field: 'BWRK_MY_CALC_STD_DT', editable: false, dataType: 'string' }, 
            { field: 'BIZAREA_CD', editable: false, dataType: 'string' }, 
            { field: 'BIZAREA_NM', editable: false, dataType: 'string' }, 
            { field: 'RMK_NM', editable: false, dataType: 'string' }, 
            { field: 'LEDU_NM', editable: false, dataType: 'string' }, 
            { field: 'ORIG_PSTN_CD ', editable: false, dataType: 'string' }, 
            { field: 'ORIG_TRGT_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'ORIG_UGRD_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'ORIG_MIN_BWRK_MY', editable: false, dataType: 'string' }, 
            { field: 'SEQ', editable: false, dataType: 'number' }, 
            { field: 'COMBINED_KEY', editable: false, dataType: 'string' }
          ]
    
        }
      }
    });
    dews.api.get(dews.url.getApiUrl('CM', 'CommonCodeDtlService', 'common_codeDtl_list'),{
      async: false,
      data: {
          dept_cd: '',
          base_dt: '',
          end_dt: '',
          crud_fg: '',
          menu_cd: '',
          foreign_yn: '',
          up_sysdef_cd: '',
          field_cd_pipe: 'P00650|ZA11_10005|P00670',
          module_cd: 'HR',
          company_cd: '',
          syscode_yn: '',
          keyword: '',
          base_yn: ''
      }
    }).done(function (data) {
      var ar_P00650 = new Array();
      var ar_ZA11_10005 = new Array();
      var ar_P00670 = new Array();
    
      for (var i = 0; i < data.length; i++) {
        if (data[i].FIELD_CD == "P00650") { 
          ar_P00650.push(data[i]); 
    
        }
        else if (data[i].FIELD_CD == "ZA11_10005") { 
          ar_ZA11_10005.push(data[i]); 
    
        }
        else if (data[i].FIELD_CD == "P00670") { 
          ar_P00670.push(data[i]); 
    
        }
      }
      self.pipeDataSource1_P00650 = dews.ui.dataSource('pipeDataSource1_P00650',  { data: ar_P00650 });
      self.pipeDataSource1_ZA11_10005 = dews.ui.dataSource('pipeDataSource1_ZA11_10005',  { data: ar_ZA11_10005 });
      self.pipeDataSource1_P00670 = dews.ui.dataSource('pipeDataSource1_P00670',  { data: ar_P00670 });
      self.pipeDataSource1 = dews.ui.dataSource('pipeDataSource1', { data: data });
      
    });
    dews.api.get(dews.url.getApiUrl('CM', 'CommonCodeDtlService', 'common_ci_codeDtl_list'),{
      async: false,
      data: {
          end_dt: '',
          foreign_yn: '',
          field_cd_pipe: 'P00650|P00670',
          module_cd: 'HR',
          syscode_yn: '',
          keyword: '',
          base_yn: ''
      }
    }).done(function (data) {
      var ar_P00650 = new Array();
      var ar_P00670 = new Array();
    
      for (var i = 0; i < data.length; i++) {
        if (data[i].FIELD_CD == "P00650") { 
          ar_P00650.push(data[i]); 
    
        }
        else if (data[i].FIELD_CD == "P00670") { 
          ar_P00670.push(data[i]); 
    
        }
      }
      self.pipeDataSource2_P00650 = dews.ui.dataSource('pipeDataSource2_P00650',  { data: ar_P00650 });
      self.pipeDataSource2_P00670 = dews.ui.dataSource('pipeDataSource2_P00670',  { data: ar_P00670 });
      self.pipeDataSource2 = dews.ui.dataSource('pipeDataSource2', { data: data });
      
    });
    self.bizareaCd_ds = dews.ui.dataSource('bizareaCd_ds', {
      transport: {
        read: {
          url: dews.url.getApiUrl('HR', 'HRPamprg00100_X10005Service', 'get_BizareaList')
        }
      },
      schema: {
        model: {
          fields: [
            { field: 'BIZAREA_CD', editable: false, type: 'string' }, 
            { field: 'BIZAREA_NM', editable: false, type: 'string' }
          ]
    
        }
      }
    });
    self.trgt_grd_cd_ds = dews.ui.dataSource('trgt_grd_cd_ds', {
      data: [{"TRGT_GRD_CD": "K1","TRGT_GRD_NM":"K1"},{"TRGT_GRD_CD": "K2","TRGT_GRD_NM":"K2"},{"TRGT_GRD_CD": "K3","TRGT_GRD_NM":"K3"},{"TRGT_GRD_CD": "K4","TRGT_GRD_NM":"K4"},{"TRGT_GRD_CD": "K5","TRGT_GRD_NM":"K5"}]
    
    });
    self.ugrd_grd_cd_ds = dews.ui.dataSource('ugrd_grd_cd_ds', {
      data: [{"UGRD_GRD_CD": "K5","UGRD_GRD_NM":"K5"},{"UGRD_GRD_CD": "K4","UGRD_GRD_NM":"K4"},{"UGRD_GRD_CD": "K3","UGRD_GRD_NM":"K3"},{"UGRD_GRD_CD": "K2","UGRD_GRD_NM":"K2"},{"UGRD_GRD_CD": "K1","UGRD_GRD_NM":"K1"}]
    });
    self.importExcel_ds = dews.ui.dataSource('importExcel_ds', {
      grid: true,
      schema: {
        model: {
          fields: [
            { field: 'STD_YM', editable: false, dataType: 'string' }, 
            { field: 'PSTN_NM', editable: false, dataType: 'string' }, 
            { field: 'TRGT_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'UGRD_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'MIN_BWRK_MY', editable: false, dataType: 'number' }, 
            { field: 'AGGR_TERM_CNT', editable: false, dataType: 'number' }, 
            { field: 'BWRK_SGRAD_CD', editable: false, dataType: 'string' }, 
            { field: 'LEDU_CD', editable: false, dataType: 'string' }, 
            { field: 'BWRK_MY_CALC_STD_DT', editable: false, dataType: 'string' }, 
            { field: 'RMK_NM', editable: false, dataType: 'string' }
          ]
    
        }
      },
      data: []
    });
    self.forExcelDataSource = dews.ui.dataSource('forExcelDataSource', {
      grid: true,
      schema: {
        model: {
          fields: [
            { field: 'STD_YM', editable: false, dataType: 'string' }, 
            { field: 'PSTN_NM', editable: false, dataType: 'string' }, 
            { field: 'TRGT_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'UGRD_GRD_CD', editable: false, dataType: 'string' }, 
            { field: 'MIN_BWRK_MY', editable: false, dataType: 'number' }, 
            { field: 'AGGR_TERM_CNT', editable: false, dataType: 'number' }, 
            { field: 'BWRK_SGRAD_CD', editable: false, dataType: 'string' }, 
            { field: 'LEDU_CD', editable: false, dataType: 'string' }, 
            { field: 'BWRK_MY_CALC_STD_DT', editable: false, dataType: 'string' }, 
            { field: 'RMK_NM', editable: false, dataType: 'string' }
          ]
    
        }
      },
      data: []
    });
    
    
    dews.ui.mainbuttons.localize.disable(true);
    dews.ui.mainbuttons.add.click(/*71614df6-9a67-4b0a-8f1b-7fb106ef6a8f*/ function () {
    
        self.gridMaster.addRow(0);  // 그리드 제일 위쪽에 추가
        var idx = self.gridMaster.select();
        var allData = self.gridMaster.dataItems();
        var seq = allData.length > 0 ? allData.length : 0; // 데이터가 있을 경우 마지막 순번에서 +1, 없을 경우 1로 시작
    
        self.gridMaster.setCellValue(idx, 'SEQ', seq, false); // 순번 컬럼에 값 설정
        self.gridMaster.setCellValue(idx, 'STD_YM', self.mpPROMO_YEAR_MONTH.value(), false); // 기준년월에 "승급년월" 저장
        self.gridMaster.setCellValue(idx, 'bizarea_cd', self.bizarea_cd.value(), false); // 사업장 코드 저장
        self.gridMaster.setCellValue(idx, 'BIZAREA_NM', self.bizarea_cd.text(), false); // 사업장명 저장
        self.gridMaster.setCellValue(idx, 'TRGT_GRD_CD', 'K1', false); // 기본값 설정
        self.gridMaster.setCellValue(idx, 'UGRD_GRD_CD', 'K2', false); // 기본값 설정
        self.gridMaster.setCellValue(idx, 'MIN_BWRK_MY', '30', false); // 기본값 설정
        self.gridMaster.setCellValue(idx, 'BWRK_MY_CALC_STD_DT', self.mpPROMO_YEAR_MONTH.value() + "01", false); // 산정기준일에 "승급년월"의 1일로 저장
        self.gridMaster.select(idx, "PSTN_NM"); // "직급명" 컬럼으로 포커스 이동
    
    });
    dews.ui.mainbuttons.search.click(/*37fe89ce-9f9d-444b-a3a3-dfe45a8e42e2*/ function () {
        if (self.conditionpanel.validate({ tooltip: true, message: '필수 항목을 입력해 주십시요.' })) {
            if (self.grid_ds.getDirtyDataCount() != 0) {
                dews.confirm('저장하지 않은 데이터가 있습니다. 조회를 계속하시겠습니까?', "question")
                    .yes(function () {
                        searchData();
                    }).no(function () {
                        dews.ui.snackbar.warning('취소되었습니다.');
                        return false;
                    });
            } else {
                searchData();
            }
        } else {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
        }
    });
    dews.ui.mainbuttons.delete.click(/*da329bef-6f06-4958-bb9d-489a5d95db95*/ function () {
        try {
            // 체크된 행 인덱스를 가진 배열
            var checkArray = self.gridMaster.getCheckedIndex();
            if (checkArray.length == 0) { // 체크된 행이 없다면
                dews.ui.snackbar.warning("체크된 행이 없습니다."); // 스낵바 경고 띄우기
                return;
            }
            dews.confirm("삭제하시겠습니까?", "question").yes(function () {
                self.gridMaster.removeRow(checkArray); // 체크된 행 모두 삭제하기
                dews.ui.snackbar.info("저장을 눌러 삭제를 완료하세요.");
            });
        } catch (error) {
            console.error(error);
            dews.error(error);
        }
    });
    dews.ui.mainbuttons.save.click(/*de6735b5-68c0-4785-bc2d-308bb03c399d*/ function () {
        self.gridMaster.commitCell(); // 수정모드 종료
    
        var checkedIndices = self.gridMaster.getCheckedIndex();
    
        if (checkedIndices.length > 0) {
            dews.ui.snackbar.warning("중복값이 존재합니다. 체크된 데이터 삭제해주세요.");
        } else {
            // checkedIndices 배열이 비어있을 때 수행할 작업
            dews.api.post(
                dews.url.getApiUrl('HR', 'HRPamprg00100_X10005Service', 'save_HR_URGDBASETBL_INFO_X10005MST'),
                {
                    async: false,
                    data: {
                        grid_ds: JSON.stringify(self.grid_ds.getDirtyData())
                    }
                }
            ).done(function (data) {
                dews.ui.snackbar.ok('자료가 정상적으로 저장되었습니다.');
                searchData();
            }).fail(function (xhr, status, error) {
                dews.ui.snackbar.error(error);
            });
        }
    
    
        // if (self.gridMaster.getCheckedIndex())
        //     if (self.grid_ds.getDirtyDataCount() === 0) {
        //         dews.alert('변경된 데이터가 없습니다.');
        //         return false;
        //     }
    
        if (!self.gridMaster.validate().result) {
            dews.alert('필수 값이 입력되지 않은 항목이 있습니다.');
            return false;
        }
    
    });
    self.$copybtnApply.on('click', /*df183ba1-b663-4f91-b5c4-39905db4b87c*/ function (e) {
        if (self.mpPROMO_YEAR_MONTH.value() == '' || self.bizarea_cd.value() == '') {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
            return false;
        }
        if (checkListExist() == false) { // 등록된 데이터가 없으면
            copyBeforeList();
        } else { // 등록된 데이터가 있으면
            dews.confirm('기존 등록된 데이터가 삭제되고 등록됩니다.\n계속하시겠습니까?', "question")
                .yes(function () {
                    deleteBeforeList();
                    copyBeforeList();
                }).no(function () {
                });
        }
    });
    self.$downloadBtnTemplet.on('click', /*481962ba-2461-4e07-81cc-b0b656c4f1aa*/ function (e) {
        try {
            // 사업장번호 선택되어 있어야 함
            if (self.mpPROMO_YEAR_MONTH.value() == '' || self.bizarea_cd.value() == '') {
                dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
                return false;
            }
            // 데이터가 없을 시 한 줄 추가(양식)
            if (self.excelFormGrid.dataItems().length === 0) {
                self.excelFormGrid.addRow();
            }
            // 파일 이름
            var downloadFileName = dews.string.format("승급기준표등록__{0}.xlsx", dews.date.format(new Date(), "yyyyMMdd_HHmmss"));
            // Excel 서식 다운로드
            var exportToExcelOptions = {
                fileName: downloadFileName,
                exportGrids: [
                    { grid: self.excelFormGrid, sheetName: "UPLOAD" }
                ]
            }; // saveAsExcel: 그리드의 내용을 엑셀로 저장
            self.excelFormGrid.saveAsExcel(exportToExcelOptions);
            dews.ui.snackbar.ok("양식 다운로드 완료되었습니다.");
        } catch (error) {
            dews.error(error);
            console.log(error);
        }
    });
    self.$downloadBtnData.on('click', /*59f767f2-0727-4c9b-87c6-a0f0715be7cc*/ function (e) {
        if (self.mpPROMO_YEAR_MONTH.value() == '' || self.bizarea_cd.value() == '') {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
            return false;
        }
        // 파일 이름
        var downloadFileName = dews.string.format("승급기준표등록__{0}.xlsx", dews.date.format(new Date(), "yyyyMMdd_HHmmss"));
        // Excel 서식 다운로드
        var exportToExcelOptions = {
            fileName: downloadFileName,
            exportGrids: [
                { grid: self.grid_ds.STD_YM, sheetName: "UPLOAD" },
            ],
        };//saveAsExcel: 그리드의 내용을 엑셀로 저장
        self.gridMaster.saveAsExcel(exportToExcelOptions);
    });
    self.$uploadBtnApply.on('click', /*9ed4bb85-ff33-478d-ad7d-c8670429122e*/ function (e) {
        if (self.mpPROMO_YEAR_MONTH.value() == '' || self.bizarea_cd.value() == '') {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
            return false;
        }
        try {
            importExcel(e);
            // 중복 확인
        }
        catch (error) {
            dews.error(error);
            console.error(error);
        }
    });
    self.$bulkExcelUpload.on('click', /*a6e64b8b-e8f6-4d3f-a5f5-b9f42e60b0e4*/ function (e) {
        self.$content.find("#uploader").click();
    });
    self.mpPROMO_YEAR_MONTH.on('open', /*baa6b78f-2b01-4c43-bfd0-b48659d0162c*/ function (e) {
        if (self.conditionItem.validate({ tooltip: true, message: '필수 항목을 입력해 주십시요.' })) {
            if (self.grid_ds.getDirtyDataCount() >= 1) {
                dews.confirm('저장되지 않은 데이터가 있습니다.\n그래도 조회 하시겠습니까?', "question").yes(function () {
                    searchData();
                }).no(function () {
                });
            } else {
                searchData();
            }
        } else {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
        }
    });
    self.mpPROMO_YEAR_MONTH.on('change', /*9cd054b6-b7e2-4b3e-b457-5bc434526e95*/ function (e) {
        if (self.conditionpanel.validate({ tooltip: true, message: '필수 항목을 입력해 주십시요.' })) {
            if (self.grid_ds.getDirtyDataCount() >= 1) {
                dews.confirm('저장되지 않은 데이터가 있습니다.\n그래도 조회 하시겠습니까?', "question").yes(function () {
                    searchData();
                }).no(function () {
                });
            } else {
                searchData();
            }
        } else {
            dews.ui.snackbar.warning("누락된 필수값이 있습니다.");
        }
    });
    self.$aply_ym_btn.on('click', /*f375351e-f2cd-42c0-a2e3-e88865930234*/ function (e) {
        OpenDialogYm();
    });
    self.bizarea_cd.setDataSource(self.bizareaCd_ds);
    self.bizarea_cd.on('change', /*9d0c5005-009c-4935-bfac-11f9df587d44*/ function (e) {
        self.grid_ds.read();
    });
    dews.ui.grid(self.$gridMaster, {
      dataSource: self.grid_ds,
      editable: true,
      selectable: true,
      sortable: false,
      noData: true,
      noDataMessage: '데이터가 없습니다',
      copyMode: 'cell',
      movable: true,
      columns: [
        {
          field: 'STD_YM',
          title: '기준년월',
          width: 60,
          attributes: { class: 'required' },
          editor: {
            type: 'multiline',
            minHeight: '0px',
            maxLength: 0
          }
        },
        {
          field: 'PSTN_CD',
          title: '직급코드',
          width: 80,
          visible: false
        },
        {
          field: 'PSTN_NM',
          title: '직급명',
          width: 90,
          align: 'left',
          attributes: { class: 'required' },
          editor: {
            type: 'codepicker',
            helpCode: 'H_MA_CODEDTL_S',
            codeField: 'SYSDEF_CD',
            textField: 'SYSDEF_NM',
            gridCodeField: 'PSTN_CD',
            gridTextField: 'PSTN_NM',
            helpTitle: '코드 도움창',
            helpSize: 'medium',
            helpParams: /*ad6ff1a1-9589-4d22-a430-33fc07d92418*/ function() {
      return {
        company_cd : "0126",
        module_cd : 'HR',
        field_cd : 'P00650'
      }
    }
          }
        },
        {
          field: 'TRGT_GRD_CD',
          title: '대상등급',
          width: 80,
          attributes: { class: 'required' },
          editor: {
            type: 'dropDown',
            dataSource: self.trgt_grd_cd_ds,
            dataValueField: 'TRGT_GRD_CD',
            dataTextField: 'TRGT_GRD_NM'
          }
        },
        {
          field: 'UGRD_GRD_CD',
          title: '승급등급',
          width: 80,
          attributes: { class: 'required' },
          editor: {
            type: 'dropDown',
            dataSource: self.ugrd_grd_cd_ds,
            dataValueField: 'UGRD_GRD_CD',
            dataTextField: 'UGRD_GRD_NM'
          }
        },
        {
          field: 'MIN_BWRK_MY',
          title: '최소근무월수',
          width: 90,
          attributes: { class: 'required' }
        },
        {
          field: 'AGGR_TERM_CNT',
          title: '근무성적집계기간',
          width: 110
        },
        {
          field: 'BWRK_SGRAD_CD',
          title: '근무성적',
          width: 80,
          editor: {
            type: 'dropDown',
            dataSource: self.pipeDataSource1_ZA11_10005,
            dataValueField: 'SYSDEF_CD',
            dataTextField: 'SYSDEF_NM'
          }
        },
        {
          field: 'LEDU_NM',
          title: '학력',
          width: 80,
          editor: {
            type: 'codepicker',
            helpCode: 'H_MA_CODEDTL_S',
            codeField: 'SYSDEF_CD',
            textField: 'SYSDEF_NM',
            gridCodeField: 'LEDU_CD',
            gridTextField: 'LEDU_NM',
            helpTitle: '학력 도움창',
            helpSize: 'medium',
            helpParams: /*587d6f15-8773-479c-a310-f91ef8ac5829*/ function(e) {
      return {
                company_cd : "0126",
                module_cd : "HR",
                field_cd : "P00670"
              }
    }
          }
        },
        {
          field: 'LEDU_CD',
          title: '학력코드',
          width: 80,
          visible: false,
          editor: {
            type: 'codepicker',
            helpCode: 'H_MA_CODEDTL_S',
            codeField: 'SYSDEF_CD',
            textField: 'SYSDEF_NM',
            gridCodeField: 'LEDU_CD',
            helpTitle: '학력 도움창',
            helpSize: 'medium',
            helpParams: /*587d6f15-8773-479c-a310-f91ef8ac5829*/ function(e) {
      return {
                company_cd : "0126",
                module_cd : "HR",
                field_cd : "P00670"
              }
    }
          }
        },
        {
          field: 'BWRK_MY_CALC_STD_DT',
          title: '산정기준일',
          width: 80,
          formats: {
            type: 'date',
            format: 'yyyy-MM-dd'
          },
          editor: {
            type: 'date',
            format: 'yyyy-MM-dd'
          }
        },
        {
          field: 'BIZAREA_CD',
          title: '사업장',
          width: 80,
          visible: false
        },
        {
          field: 'BIZAREA_NM',
          title: '사업장명',
          width: 90,
          align: 'left',
          visible: false
        },
        {
          field: 'RMK_NM',
          title: '비고',
          width: 90
        },
        {
          field: 'SEQ',
          title: '순번',
          formats: {
            type: 'number',
            predefined: true
          }
        },
        {
          field: 'ORIG_PSTN_CD',
          title: '수정이전 직급코드',
          visible: false
        },
        {
          field: 'ORIG_MIN_BWRK_MY',
          title: '수정이전 최소근무월수',
          visible: false
        },
        {
          field: 'ORIG_TRGT_GRD_CD',
          title: '수정이전 대상코드',
          visible: false
        },
        {
          field: 'ORIG_UGRD_GRD_CD',
          title: '수정이전 승급등급코드',
          visible: false
        },
        {
          field: 'COMBINED_KEY',
          title: '결합키'
        }
      ],
      fixed: {
        colCount: 0,
        rightColCount: 0
      }
    });
    dews.ui.grid(self.$excelFormGrid, {
      dataSource: self.forExcelDataSource,
      sortable: false,
      autoBind: false,
      checkable: false,
      copyMode: 'cell',
      columns: [
        {
          field: 'STD_YM',
          title: '기준년월',
          width: 60
        },
        {
          field: 'PSTN_NM',
          title: '직급명',
          width: 90,
          align: 'left'
        },
        {
          field: 'TRGT_GRD_CD',
          title: '대상등급',
          width: 80
        },
        {
          field: 'UGRD_GRD_CD',
          title: '승급등급',
          width: 80
        },
        {
          field: 'MIN_BWRK_MY',
          title: '최소근무월수',
          width: 60
        },
        {
          field: 'AGGR_TERM_CNT',
          title: '근무성적집계기간수',
          width: 60
        },
        {
          field: 'BWRK_SGRAD_CD',
          title: '근무성적',
          width: 80
        },
        {
          field: 'LEDU_CD',
          title: '학력코드',
          width: 80
        },
        {
          field: 'BWRK_MY_CALC_STD_DT',
          title: '산정기준일',
          width: 80,
          formats: {
            type: 'date',
            format: 'yyyy-MM-dd'
          },
          editor: {
            type: 'date',
            format: 'yyyy-MM-dd'
          }
        },
        {
          field: 'RMK_NM',
          title: '비고',
          width: 90,
          align: 'left'
        }
      ],
      fixed: {
        colCount: 0,
        rightColCount: 0
      }
    });
    dews.ui.grid(self.$importExcelGrid, {
      dataSource: self.importExcel_ds,
      sortable: false,
      autoBind: false,
      checkable: false,
      copyMode: 'cell',
      columns: [
        {
          field: 'STD_YM',
          title: '기준년월',
          width: 60
        },
        {
          field: 'PSTN_NM',
          title: '직급명',
          width: 90,
          align: 'left'
        },
        {
          field: 'TRGT_GRD_CD',
          title: '대상등급',
          width: 80
        },
        {
          field: 'UGRD_GRD_CD',
          title: '승급등급',
          width: 80
        },
        {
          field: 'MIN_BWRK_MY',
          title: '최소근무월수',
          width: 60
        },
        {
          field: 'AGGR_TERM_CNT',
          title: '근무성적집계기간',
          width: 60
        },
        {
          field: 'BWRK_SGRAD_CD',
          title: '근무성적',
          width: 80
        },
        {
          field: 'LEDU_CD',
          title: '학력코드',
          width: 80
        },
        {
          field: 'BWRK_MY_CALC_STD_DT',
          title: '산정기준일',
          width: 80,
          formats: {
            type: 'date',
            format: 'yyyy-MM-dd'
          },
          editor: {
            type: 'date',
            format: 'yyyy-MM-dd'
          }
        },
        {
          field: 'RMK_NM',
          title: '비고',
          width: 90,
          align: 'left'
        }
      ],
      fixed: {
        colCount: 0,
        rightColCount: 0
      }
    });
    
    
    
    
    /*534ba9e1-a845-40e6-8d1e-d324d5bfa4cc*/ self.mpPROMO_YEAR_MONTH.value(getCurrentMonth()); //데이터 있는 기준 날짜 확인해야 함 
    self.gridMaster.SEQ = 0;
    self.grid_ds.read();
    
    
    

  
  });

</script>